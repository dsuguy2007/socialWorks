<?
$this->headScript()->appendFile('/js/vendor/bootstrap-datepicker.js');
$this->headLink()->appendStylesheet('/css/datepicker.css');
?>
<form action="/isp/goals" method="post" id="isp-gen-medical" >
<?= $this->partial("/isp/partials/progress.phtml", array('percentComplete'=>$this->percentComplete,
                                                         'back'=>'/isp/info',
                                                         'id' => $this->consumer->id,
                                                         'next'=>true,
                                                         'formName'=>$this->formName,
                                                         'steps'=>$this->steps,
                                                         'activeStep'=>$this->activeStep)); ?>
<div class="row">
    <div class="span12">
       <div class="well">
       <h3>Medical Information for <?=$this->consumer->fname?> <?=$this->consumer->lname?> </h3>
       
	   <table class="table table-striped">
		<thead>
			<tr>
				<th>Insurance Type</th>
				<th>Medical #</th>
				<th>Medicare #</th>
				<th>Information</th>
			</tr>
		</thead>
	   <tbody>
		
		<?foreach($this->insurance as $k=>$i):?>
			<tr>
			<td><?=$i['type']?></td>
			<td><?=$i['medical_number']?></td>
			<td><?=$i['medicare_number']?></td>
			<td><?=$i['insurance_info']?></td>
			</tr>
		<?endforeach;?>
	   </tbody>
	   </table>
	   <hr />
	   
	   
	   <strong>Select Exam information for <?=$this->consumer->fname?> <?=$this->consumer->lname?> </strong>
       <input type="hidden" name="id" value="<?=$this->consumer->id?>" />
	   <a class=" pointer crud-new-update-med btn btn-primary pull-right"
		  data-cid="<?=$this->consumer->id?>" data-id=''> Add Info <i class="icon-plus"></i> </a>
	   <hr />
	   
	   <div class="max-height-450px overflow-auto">
	   
<? if(isset( $this->physicians )): ?>
    <?= $this->TableHead( array("Physician Name",
                                "Address",
                                "Phone",
                                "Exam Type",
                                "Date of Last Exam",
                                "Result of Exam",
                                "Edit",
                                "Delete" ), "table table-bordered js-med-index" ) ?>
    <?foreach($this->physicians as $p):?>
    <?foreach($p['exams'] as $e):
	 $strDate = strtotime( $e->date );
	?>
        <?= $this->TableRow(array( $p["name"],
                                   $p["address"],
                                   $p["phone"],
                                   $e->type,
                                   date('m/d/Y', $strDate ),
                                   $e->result,
                                   "<a class='pointer crud-new-update-med' data-id='{$e->id}' data-cid='{$this->consumer->id}'><i class='icon-edit'></i></a>",
                                   "<a id='med-{$e->id}'
                                   class='pointer crud-del-med' data-id='{$e->id}' data-cid='{$this->consumer->id}' title='delete'><i class='icon-remove'></i></a>",
                                   ), "class='exam-row-{$e->id} highlight-child'"); ?>
    <?endforeach;?>
    <?endforeach;?>
    <?= $this->TableFoot() ?>
<?endif;?>

</div>

	   <a class=" pointer crud-new-update-med btn btn-primary pull-right"
		  data-cid="<?=$this->consumer->id?>" data-id=''> Add Exam Info <i class="icon-plus"></i> </a>

     </div>
    </div>
    
</div>

</form>

<script type="text/javascript">

$(function(){
	  /*
	  * Crud New/Edit Medical Exam Form
	  */
	  $("body").delegate("a.crud-new-update-med", "click", function() {
		
		var el  = $(this);
		var cid = el.attr('data-cid');
		var id  = el.attr('data-id');
		var path = '/consumer/exam/';
		var action =  id != '' ? 'edit': 'new';
		
		lightBox.show('mainModal', 'Add Medical Info',
					  {'remote':path+action+'/'+id+'/',
					   'params': { cid:cid, id:id },
					   'callback':function(data) {
			    
						var examDate  = $("#date-element");
							
						var dateField = $("#date");
							dateField.attr('readonly','readonly' );
						
						var template  = _.template($('#date-template').html());	
						var efield    = examDate.html();
						examDate.html("");
						
						$("#date-element").append(template({start:'now',field:efield}));
						$("#date-picker").datepicker({format:'yyyy-mm-dd'}).on('changeDate', function(ev){});
						$("#consumerexamform").append('<input type="button" value="Submit" class="js-exam-form-'+action+' btn" />');
					}},
					'get');
	  });  
	 
	 /*
	  * Crud Create Med Submit
	  */
	  $("body").delegate( ".js-exam-form-new", "click", function() {
		Crud.Create('/consumer/exam/new/',
			'consumerexamform', function(data) {
				var template = _.template($("#js-crud-edit-med").html());
				$(".js-med-index").prepend("<tr class='exam-row-"+data.id+" highlight-child'>"+template(data)+"</tr>");
		}, 'json' );
	  });
	
	 /*
	  * Crud Update Med Submit
	  */
	  $("body").delegate( ".js-exam-form-edit", "click", function() {
		Crud.Update('/consumer/exam/edit/',
			'consumerexamform', function(data) {
				var template = _.template($("#js-crud-edit-med").html());
				var el = $(".exam-row-"+data.id);
			      	el.html(template(data));
					el.css({'display':'none'});
					el.fadeIn(1000, function() {  });
				$("#mainModalLabel").html("<i class='alert alert-success'>Medical Info Updated</i>");
		}, 'json' );
	  });

	  /*
	   Curd Delete
	  */
      $("body").delegate(".crud-del-med", "click", function() {
		 
		 var el = $(this);
         var id =  el.attr('data-id');
         var cd = el.attr('data-cid');
		 
		 Crud.Confirm({ url: '/consumer/exam/delete/',
					   params: {id: id, cid:cd },
					   title: 'Please confirm deleting of Medical Info.',
					   text:  'The record will be completelly removed! Is it ok?',
					   ok: 'Remove',
					   cancel: 'Cancel'
		  }).done(function(data) {
			  var el = $("#med-"+data.id).parent().parent();
			      el.css({'color':'red'});
			      el.fadeOut(1000, function() { $(this).remove(); });
		  }).fail(function() {
		  });
		  });
	  
		});

</script>

<script type="text/plain" id="js-crud-edit-med">	
	
	<td><%= physician.name %></td>
	<td><%= physician.address %></td>
	<td><%= physician.phone %></td>
	<td><%= values.type %></td>
	<td><%= values.date %></td>
	<td><%= values.result %></td>
	<td><a class='pointer crud-new-update-med' data-id='<%= values.id %>' data-cid='<%= consumer_id %>'><i class='icon-edit'></i></a></td>
	<td><a title="delete" data-cid="<%= consumer_id %>" data-id="<%= values.id %>"
		   class="pointer crud-del-med" id="med-<%= values.id %>"><i class="icon-remove"></i></a></td>
	
</script>
